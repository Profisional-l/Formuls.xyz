<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Formuls Calc</title>
    <script defer src="//unpkg.com/mathlive"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-1BFTX7VGPT');
    </script>
     <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
     <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
 
    <meta charset="UTF-8">
    <link rel="alternate" href="android-app://com.finetest.formuls/">
    <meta name="theme-color" content="#252525">
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <include src="./forapple.html"></include>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
    <meta name="keywords" content="Физика, цт, цэ, егэ, огэ, экзамен, сдать, formuls, формулс, 100 баллов, 100цт">
    <meta name="title" content="Formuls">
    <meta name="description" content="Formuls - подготовка к экзамену (ЦТ | ЦЭ | ЕГЭ) по физике. Легко запоминай формулы и сдавай экзамен на 100 баллов!">
    <title>Formuls - подготовка к экзамену (ЦТ | ЦЭ | ЕГЭ) по физике на 100 баллов!</title>
</head>
<div class="mask">
    <div class="loader"></div>
  </div>
<body>
    <div class="page-transition-overlay"></div>


    <header>
        <a href="https://formuls.xyz/"><img class="logoIMG" src="./images/monologo.png" alt=""></a>
        <h3 class="logo"><a href="https://formuls.xyz/">Formuls</a></h3>
        <img src="./images/sun.png" style="display: none;" alt="">
                         
            </a></h3>

        <div class="switcherparent">
            <!-- Rounded switch -->
            <label class="switch">
                <input id="checkboxswitcher" type="checkbox" onchange="handleChange(this.checked)">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="godownload">
            <a href="./appdownload.html"><button class="downloadbut" type="submit"><img src="./images/downloads (1).png" width="25px" alt=""></button></a>
        </div>

    </header>
 
  <div class="maincalc">
   
    <br>
    <div class="mathfieldparent">
        <math-field id="userInputField" placeholder="Ввод"></math-field>
</div>
<br>
<div id="result" style=" font-family: Arial, Helvetica, sans-serif;"><div style="color: #747474;">Ответ:</div><div class="calcloader"></div></div>
<div id="resultgraph" style=" font-family: Arial, Helvetica, sans-serif;"><div style="color: #747474;">График:</div><div class="calcloader"></div></div>

        <br>
        <button onclick="sendData()" class="but calcstart" style="display: inline-block; max-width: 170px; height: 45px;">Решить</button>
    <br><br>
    <div class="switchersCont">
       
        <div class="MathSWParent">
            <p>Вычислять <br> ответ</p>
        <label class="switch math primotv">
            <input id="checkboxswitcher" type="checkbox" onchange="isPrimotv()">
            <span class="slider mathSlider round "></span>
        </label>
        <br>
        </div>

        <div class="MathSWParent">
            <p>Комплекные <br> числа</p>

            <label class="switch math complex">
            <input id="checkboxswitcher" type="checkbox" onchange="isComplex()">
            <span class="slider mathSlider complex round "></span>
        </label>
        <br>
        </div>
        <div class="MathSWParent">
            <p>Ход решения</p>
        <label class="switch math hodreshen">
            <input id="checkboxswitcher" type="checkbox" onchange="isHodreshen()">
            <span class="slider mathSlider round "></span>
        </label>
        <br>
        </div>
        <div class="MathSWParent">
            <p>График</p>
        <label class="switch math graph">
            <input id="checkboxswitcher" type="checkbox" onchange="isGraph()">
            <span class="slider mathSlider round "></span>
        </label>
        <br>
        </div>
        <div class="madewithParent">
            <t id="madewith">Made with <a href="https://t.me/anttany">Markovka</a> </t>
       </div>
      
    </div>
    
    <!-- <div id="result" style="margin-top: 40px; font-size: 20px; overflow-x: auto;"></div> -->
    <script src="./erwr.js" type="module">
 
    </script>
        
    <script>
        
        const calcloader = document.querySelector('.calcloader');
        calcloader.style.display = "none";
        const resultElement = document.getElementById('result');
        const calcBut = document.querySelector('.but.calcstart');

        var isPrimotvToF = false;
        var isComplexToF = false;
        var isStepsToF = false;
        var isGraphToF = false;

        // Определение функции formatMathJax
        function formatMathJax(elementId, mathExpression) { 
            const element = document.getElementById(elementId); 
            if (!element) { 
                console.error(`Элемент с id "${elementId}" не найден.`); 
                return; 
            } 
 
            // Разбиваем строку на подстроки по тегу </br> 
            const expressions = mathExpression.split('</br>'); 
 
            // Форматируем каждую подстроку отдельно 
            let formattedExpression = ''; 
            expressions.forEach(expression => { 
                const replacedExpression = expression.replace(/Производная/g, 'Производнаяㅤ'); 
                 
                formattedExpression += `$$${replacedExpression}$$<br>`; 
            }); 
 
            // Устанавливаем HTML содержимое элемента 
            element.innerHTML = formattedExpression; 
 
            // Перерисовываем элемент с использованием MathJax 
            MathJax.typeset([element]); 
        }

        function isPrimotv() {
        isPrimotvToF = !isPrimotvToF;
        // const userInputField = document.getElementById('userInputField');
        // var userInput = userInputField.value;
        // if (userInput != "") {
        //     sendData()
        // }
    }

        function isComplex() {
        isComplexToF = !isComplexToF;
        // const userInputField = document.getElementById('userInputField');
        // var userInput = userInputField.value;
        // if (userInput != "") {
        //     sendData()
        // }
        }
        function isHodreshen() {
        isStepsToF = !isStepsToF;
        }

        function isGraph() {
        isGraphToF = !isGraphToF;
        }

        async function sendData() {
            try {
                const userInputField = document.getElementById('userInputField');
                if (!userInputField) {
                    throw new Error('Элемент с id "userInputField" не найден.');
                }
                var userInput = userInputField.value;
                function WhoChacked() {
                    if (isPrimotvToF === true) {
                        userInput = userInput + " primotv";
                    }
                    if (isComplexToF === true) {
                        userInput = userInput + " complexotv";
                    }
                    if (isStepsToF === true) {
                        userInput = userInput + " stepbystep";
                    }
                    
                }
                WhoChacked()

                
                calcloader.style.display = "block";
                resultElement.innerHTML = '<div class="calcloader"></div>';
                calcBut.style.backgroundColor="#5a5a5a";
                calcBut.style.color="#acacac";
                calcBut.disabled = true;

                // Выводим данные в консоль
                console.log('Отправляемые данные:', userInput);
                console.log("isPrimotvToF: " + isPrimotvToF);
                console.log("isComplexToF: " + isComplexToF);

             // const responseIMG = await fetch('https://epsilon-math.ru/graph.png', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify({ 'user_input': userInput}),
                // });
                const response = await fetch('https://epsilon-math.ru/process_input/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'user_input': userInput }),
        });

        if (response.ok) {
            const result = await response.json();
            if (isGraphToF === true && result.new_key.includes('graph')) {
                const resultGraphElement = document.getElementById('resultgraph');
                const timestamp = new Date().getTime(); // Уникальный параметр для обновления изображения
                resultGraphElement.innerHTML = `<img src='https://epsilon-math.ru/graph.png?${timestamp}'>`;
            }
                    // const resultGraph = await responseIMG.json();
                    
                    if (!resultElement) {
                        throw new Error('Элемент с id "result" не найден.');
                    }

                 if (result && typeof result.new_key !== 'undefined') {
                    formatMathJax('result', result.new_key);
                    // let numbers = document.querySelectorAll("mjx-c");
                    // numbers.forEach(n => {
                    //     n.style.padding = "1px";
                    //     // n.style.fontFamily = "sans-serif";
                    //     calcloader.style.display = "none";
                        
                    // });
                    console.log('Результат отображен на странице.');
                        calcBut.style.backgroundColor="#2f2f2f";
                        calcBut.style.color="#ffffff";
                        calcBut.disabled = false;
                } else {
                    console.error('Ответ от сервера не содержит ожидаемого свойства "new_key".', result);
                }

                } else {
                    console.error('Ошибка при отправке данных на сервер:', response.status);
                }

            } catch (error) {
                console.error(error.message);
            }
        }

    
    </script>
    
    <script src="./theme.js"></script>
    <script>
        let LogoName = document.querySelector('.logo')
        let LogoIMG = document.querySelector('.logoIMG')
        function changeLogoType() {
          LogoName.classList.add('changeLOGOout')
          LogoIMG.classList.add('changeLOGOin')
        }
        changeLogoType()
    </script>
    <style>
        .MJX-TEX {
    font-family: MJXZERO, MJXTEX;
}
    </style>
</body>
</html>
